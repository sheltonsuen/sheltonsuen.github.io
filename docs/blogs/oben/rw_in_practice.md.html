<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-6e20702d1fdd0ee7.js" defer=""></script><script src="/_next/static/chunks/framework-0bff4c72fef67389.js" defer=""></script><script src="/_next/static/chunks/main-4abec45f7c95ce5e.js" defer=""></script><script src="/_next/static/chunks/pages/_app-1df1ee81c516dd4b.js" defer=""></script><script src="/_next/static/chunks/pages/blogs/%5B...names%5D-2e012eacd3022c9d.js" defer=""></script><script src="/_next/static/vOdQCyDahnHhbJ7mWv278/_buildManifest.js" defer=""></script><script src="/_next/static/vOdQCyDahnHhbJ7mWv278/_ssgManifest.js" defer=""></script><script src="/_next/static/vOdQCyDahnHhbJ7mWv278/_middlewareManifest.js" defer=""></script><style data-styled="" data-styled-version="5.3.3">body{margin:0;padding:0;box-sizing:border-box;}/*!sc*/
#__next{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}/*!sc*/
data-styled.g1[id="sc-global-ejORCz1"]{content:"sc-global-ejORCz1,"}/*!sc*/
.cRaYml{width:100%;height:100%;vertical-align:middle;border-radius:50%;}/*!sc*/
data-styled.g2[id="Avatar__Img-sc-j2rhp9-0"]{content:"cRaYml,"}/*!sc*/
.itjVmX{padding:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;list-style:none;border-bottom:1px solid #cacfd2;}/*!sc*/
data-styled.g3[id="HeaderMenu__MenuWrapper-sc-14dkklk-0"]{content:"itjVmX,"}/*!sc*/
.kIlpOB{line-height:32px;min-width:96px;text-align:center;border-bottom:none;}/*!sc*/
.bNdHDE{line-height:32px;min-width:96px;text-align:center;border-bottom:2px solid #EB984E;}/*!sc*/
data-styled.g4[id="HeaderMenu__MenuItem-sc-14dkklk-1"]{content:"kIlpOB,bNdHDE,"}/*!sc*/
.dGCYZo{-webkit-text-decoration:none;text-decoration:none;color:#24292f;}/*!sc*/
data-styled.g5[id="HeaderMenu__Link-sc-14dkklk-2"]{content:"dGCYZo,"}/*!sc*/
.bmDBta{margin:0;padding:32px 16px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;width:1280px;}/*!sc*/
data-styled.g6[id="PageWrapper__Wrapper-sc-859ve4-0"]{content:"bmDBta,"}/*!sc*/
.Kjbfq{width:256px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-flow:column nowrap;-ms-flex-flow:column nowrap;flex-flow:column nowrap;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}/*!sc*/
@media (max-width:768px){.Kjbfq{display:none;}}/*!sc*/
data-styled.g7[id="PageWrapper__SideBarWrapper-sc-859ve4-1"]{content:"Kjbfq,"}/*!sc*/
.ikqffP{-webkit-flex:1;-ms-flex:1;flex:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-flow:column nowrap;-ms-flex-flow:column nowrap;flex-flow:column nowrap;}/*!sc*/
data-styled.g9[id="PageWrapper__MainContentWrapper-sc-859ve4-3"]{content:"ikqffP,"}/*!sc*/
.jeBpnd{width:128px;height:128px;margin:32px 0 8px 0;}/*!sc*/
data-styled.g10[id="PageWrapper__StyledAvatar-sc-859ve4-4"]{content:"jeBpnd,"}/*!sc*/
.jIJyRi{margin-bottom:4px;font-size:1.6rem;}/*!sc*/
data-styled.g11[id="PageWrapper__Name-sc-859ve4-5"]{content:"jIJyRi,"}/*!sc*/
</style></head><body><div id="__next" data-reactroot=""><div class="PageWrapper__Wrapper-sc-859ve4-0 bmDBta"><div class="PageWrapper__SideBarWrapper-sc-859ve4-1 Kjbfq"><img class="Avatar__Img-sc-j2rhp9-0 cRaYml PageWrapper__StyledAvatar-sc-859ve4-4 jeBpnd" src="/avatar.jpeg"/><span class="PageWrapper__Name-sc-859ve4-5 jIJyRi">孙晓聪</span></div><div class="PageWrapper__MainContentWrapper-sc-859ve4-3 ikqffP"><menu class="HeaderMenu__MenuWrapper-sc-14dkklk-0 itjVmX"><li class="HeaderMenu__MenuItem-sc-14dkklk-1 kIlpOB"><a href="/" class="HeaderMenu__Link-sc-14dkklk-2 dGCYZo">最新</a></li><li selected="" class="HeaderMenu__MenuItem-sc-14dkklk-1 bNdHDE"><a href="/blogs" class="HeaderMenu__Link-sc-14dkklk-2 dGCYZo">博客</a></li><li class="HeaderMenu__MenuItem-sc-14dkklk-1 kIlpOB"><a href="/readings" class="HeaderMenu__Link-sc-14dkklk-2 dGCYZo">书评</a></li></menu><div class="PageWrapper__ContentWrapper-sc-859ve4-2 gUefAE"><div><h1>RW 实践</h1>
<h2>背景</h2>
<p>首先介绍一下我们团队的情况，我司数据中台团队成立于2022年初，最开始聚焦于离线数仓和报表，人员配置在6个人左右的小团队。技术架构比较复杂，组件相对来说比较臃肿，一次报表刷新的时间大概在12小时左右，在我们数据量并不是特别大的情况下效率并不高。2023年年末团队经历一波换血过后，我们就开始着手整个数据中台的架构治理。当然其他细节我就不在这儿过多介绍，比较新颖的是，为了支持风控实时计算的需求，我们引入了比较新的RisingWave作为我们实时计算的补充，同Flink一起支撑整个团队的实时流水线。</p>
<h2>RisingWave</h2>
<p>RisingWave 是一个分布式架构的 SQL 流式数据库，能简单、高效、可靠地处理流数据。RisingWave 提供增量更新、一致性的物化视图——这是一种持久的数据结构，承载了流处理的结果。RisingWave 让开发人员能够通过级联物化视图来表达复杂的流处理逻辑，从而大大降低了构建流处理应用的难度。此外，它还允许用户直接在系统内持久化数据，而无需将结果传送到外部数据库进行存储和查询。</p>
<h2>整体架构</h2>
<p><img src="https://sheltonsuen.github.io/dp_arch.jpg" alt="dp arch"></p>
<h2>案例</h2>
<h3>1. 车辆在途打标</h3>
<p>我司有一个项目需要对所有平台注册的车辆进行标记，简单来讲就是需要经过计算，然后标记车辆是否在途。这个需求相对来说比较简单，只需要查询平台跟这个车相关的订单，关联最新的位置，如果有就是在途，并且有最新位置，没有则非在途。所以对于这个案例，我们全程都是在RisingWave计算，首先通过 RW CDC 将车辆，打卡等相关表 CDC 到 RW, 然后再通过join关联车辆最新的位置（可以利用窗口函数等计算）并且标记是否在途。join后的是 Materialized View ，为了方便查询，我们又将最终的结果sink 到了 mysql 提供给业务系统查询。</p>
<h4>需要注意的是</h4>
<ul>
<li>RW CDC 以及 最后结果 Sink to mysql 都需要映射，RW 采用psql 而我们业务系统都是mysql， 所以中途的映射算是一个比较繁琐的事情</li>
<li>Timestamp &#x26; Datetime 在映射后的时区问题，需要谨慎处理，必要的时候需要单独转换</li>
<li>没有自动化部署！！！ 由于采用SQL方式，所以我们只能手动执行，曾经仓试过集成liquibase等都失败告终，最后不得不统一手动执行</li>
<li>decouple sink 如果经常遇到跑着跑着 RW 就crash 了，并且整个集群都在 crash 那应该是下游存在瓶颈导致无法checkpoint</li>
</ul>
<h3>2. 订单打标</h3>
<p>这个需求类似于第一个案例，不同的是这个需求很复杂，设计的场景比较多。如果还是通过SQL来做就不是很合适，也不方便测试。好在RW提供了UDF，并且支持多种方式的UDF部署方式，可以嵌入也可以远程部署，这给与了我们很大的扩展空间。综合考虑，我们采用 java UDF 并且部署为remote service。整个流水线就变了为了 RW CDC 将订单信息通过到RW， RW MV 调用 remote UDF 对每一个订单进行打标，最后将结果sink到mysql 供业务系统查询。</p>
<h4>需要注意的是</h4>
<ul>
<li>remote service 的调用并不是很稳定，1万次总有几次失败，可能是网络抖动，这个时候就需要设置失败重试，否则就会得到NULL值</li>
</ul>
<h2>整体使用感受</h2>
<p>最开始接触这个还是比较抗拒的，毕竟已经有业界比较成熟的Flink 摆在哪儿，当时我们是从比较早的版本开始试用的，还是经常能遇到一些bug，好在RW团队还是比较敏捷，团队修复发布速度较快。
整体稳定性也有待提高，偶尔因为性能问题会导致整个集群崩溃，etcd也不是很好恢复。</p>
</div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"blog":{"name":"rw_in_practice.md","categories":["oben"],"content":"\n# RW 实践\n\n## 背景\n首先介绍一下我们团队的情况，我司数据中台团队成立于2022年初，最开始聚焦于离线数仓和报表，人员配置在6个人左右的小团队。技术架构比较复杂，组件相对来说比较臃肿，一次报表刷新的时间大概在12小时左右，在我们数据量并不是特别大的情况下效率并不高。2023年年末团队经历一波换血过后，我们就开始着手整个数据中台的架构治理。当然其他细节我就不在这儿过多介绍，比较新颖的是，为了支持风控实时计算的需求，我们引入了比较新的RisingWave作为我们实时计算的补充，同Flink一起支撑整个团队的实时流水线。\n\n## RisingWave\nRisingWave 是一个分布式架构的 SQL 流式数据库，能简单、高效、可靠地处理流数据。RisingWave 提供增量更新、一致性的物化视图——这是一种持久的数据结构，承载了流处理的结果。RisingWave 让开发人员能够通过级联物化视图来表达复杂的流处理逻辑，从而大大降低了构建流处理应用的难度。此外，它还允许用户直接在系统内持久化数据，而无需将结果传送到外部数据库进行存储和查询。\n\n## 整体架构\n![dp arch](https://sheltonsuen.github.io/dp_arch.jpg) \n\n## 案例\n\n### 1. 车辆在途打标\n我司有一个项目需要对所有平台注册的车辆进行标记，简单来讲就是需要经过计算，然后标记车辆是否在途。这个需求相对来说比较简单，只需要查询平台跟这个车相关的订单，关联最新的位置，如果有就是在途，并且有最新位置，没有则非在途。所以对于这个案例，我们全程都是在RisingWave计算，首先通过 RW CDC 将车辆，打卡等相关表 CDC 到 RW, 然后再通过join关联车辆最新的位置（可以利用窗口函数等计算）并且标记是否在途。join后的是 Materialized View ，为了方便查询，我们又将最终的结果sink 到了 mysql 提供给业务系统查询。\n\n#### 需要注意的是\n* RW CDC 以及 最后结果 Sink to mysql 都需要映射，RW 采用psql 而我们业务系统都是mysql， 所以中途的映射算是一个比较繁琐的事情\n* Timestamp \u0026 Datetime 在映射后的时区问题，需要谨慎处理，必要的时候需要单独转换\n* 没有自动化部署！！！ 由于采用SQL方式，所以我们只能手动执行，曾经仓试过集成liquibase等都失败告终，最后不得不统一手动执行\n* decouple sink 如果经常遇到跑着跑着 RW 就crash 了，并且整个集群都在 crash 那应该是下游存在瓶颈导致无法checkpoint\n\n### 2. 订单打标\n这个需求类似于第一个案例，不同的是这个需求很复杂，设计的场景比较多。如果还是通过SQL来做就不是很合适，也不方便测试。好在RW提供了UDF，并且支持多种方式的UDF部署方式，可以嵌入也可以远程部署，这给与了我们很大的扩展空间。综合考虑，我们采用 java UDF 并且部署为remote service。整个流水线就变了为了 RW CDC 将订单信息通过到RW， RW MV 调用 remote UDF 对每一个订单进行打标，最后将结果sink到mysql 供业务系统查询。\n\n#### 需要注意的是\n* remote service 的调用并不是很稳定，1万次总有几次失败，可能是网络抖动，这个时候就需要设置失败重试，否则就会得到NULL值\n\n## 整体使用感受\n最开始接触这个还是比较抗拒的，毕竟已经有业界比较成熟的Flink 摆在哪儿，当时我们是从比较早的版本开始试用的，还是经常能遇到一些bug，好在RW团队还是比较敏捷，团队修复发布速度较快。\n整体稳定性也有待提高，偶尔因为性能问题会导致整个集群崩溃，etcd也不是很好恢复。\n","meta":{"title":"RW 实践","date":"Wed Oct 09 2024 00:00:00 GMT+0000 (Coordinated Universal Time)","tags":"oben","private":false}},"html":"\u003ch1\u003eRW 实践\u003c/h1\u003e\n\u003ch2\u003e背景\u003c/h2\u003e\n\u003cp\u003e首先介绍一下我们团队的情况，我司数据中台团队成立于2022年初，最开始聚焦于离线数仓和报表，人员配置在6个人左右的小团队。技术架构比较复杂，组件相对来说比较臃肿，一次报表刷新的时间大概在12小时左右，在我们数据量并不是特别大的情况下效率并不高。2023年年末团队经历一波换血过后，我们就开始着手整个数据中台的架构治理。当然其他细节我就不在这儿过多介绍，比较新颖的是，为了支持风控实时计算的需求，我们引入了比较新的RisingWave作为我们实时计算的补充，同Flink一起支撑整个团队的实时流水线。\u003c/p\u003e\n\u003ch2\u003eRisingWave\u003c/h2\u003e\n\u003cp\u003eRisingWave 是一个分布式架构的 SQL 流式数据库，能简单、高效、可靠地处理流数据。RisingWave 提供增量更新、一致性的物化视图——这是一种持久的数据结构，承载了流处理的结果。RisingWave 让开发人员能够通过级联物化视图来表达复杂的流处理逻辑，从而大大降低了构建流处理应用的难度。此外，它还允许用户直接在系统内持久化数据，而无需将结果传送到外部数据库进行存储和查询。\u003c/p\u003e\n\u003ch2\u003e整体架构\u003c/h2\u003e\n\u003cp\u003e\u003cimg src=\"https://sheltonsuen.github.io/dp_arch.jpg\" alt=\"dp arch\"\u003e\u003c/p\u003e\n\u003ch2\u003e案例\u003c/h2\u003e\n\u003ch3\u003e1. 车辆在途打标\u003c/h3\u003e\n\u003cp\u003e我司有一个项目需要对所有平台注册的车辆进行标记，简单来讲就是需要经过计算，然后标记车辆是否在途。这个需求相对来说比较简单，只需要查询平台跟这个车相关的订单，关联最新的位置，如果有就是在途，并且有最新位置，没有则非在途。所以对于这个案例，我们全程都是在RisingWave计算，首先通过 RW CDC 将车辆，打卡等相关表 CDC 到 RW, 然后再通过join关联车辆最新的位置（可以利用窗口函数等计算）并且标记是否在途。join后的是 Materialized View ，为了方便查询，我们又将最终的结果sink 到了 mysql 提供给业务系统查询。\u003c/p\u003e\n\u003ch4\u003e需要注意的是\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003eRW CDC 以及 最后结果 Sink to mysql 都需要映射，RW 采用psql 而我们业务系统都是mysql， 所以中途的映射算是一个比较繁琐的事情\u003c/li\u003e\n\u003cli\u003eTimestamp \u0026#x26; Datetime 在映射后的时区问题，需要谨慎处理，必要的时候需要单独转换\u003c/li\u003e\n\u003cli\u003e没有自动化部署！！！ 由于采用SQL方式，所以我们只能手动执行，曾经仓试过集成liquibase等都失败告终，最后不得不统一手动执行\u003c/li\u003e\n\u003cli\u003edecouple sink 如果经常遇到跑着跑着 RW 就crash 了，并且整个集群都在 crash 那应该是下游存在瓶颈导致无法checkpoint\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3\u003e2. 订单打标\u003c/h3\u003e\n\u003cp\u003e这个需求类似于第一个案例，不同的是这个需求很复杂，设计的场景比较多。如果还是通过SQL来做就不是很合适，也不方便测试。好在RW提供了UDF，并且支持多种方式的UDF部署方式，可以嵌入也可以远程部署，这给与了我们很大的扩展空间。综合考虑，我们采用 java UDF 并且部署为remote service。整个流水线就变了为了 RW CDC 将订单信息通过到RW， RW MV 调用 remote UDF 对每一个订单进行打标，最后将结果sink到mysql 供业务系统查询。\u003c/p\u003e\n\u003ch4\u003e需要注意的是\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003eremote service 的调用并不是很稳定，1万次总有几次失败，可能是网络抖动，这个时候就需要设置失败重试，否则就会得到NULL值\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2\u003e整体使用感受\u003c/h2\u003e\n\u003cp\u003e最开始接触这个还是比较抗拒的，毕竟已经有业界比较成熟的Flink 摆在哪儿，当时我们是从比较早的版本开始试用的，还是经常能遇到一些bug，好在RW团队还是比较敏捷，团队修复发布速度较快。\n整体稳定性也有待提高，偶尔因为性能问题会导致整个集群崩溃，etcd也不是很好恢复。\u003c/p\u003e\n"},"__N_SSG":true},"page":"/blogs/[...names]","query":{"names":["oben","rw_in_practice.md"]},"buildId":"vOdQCyDahnHhbJ7mWv278","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>